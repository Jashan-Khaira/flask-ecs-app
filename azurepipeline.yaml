trigger:
  branches:
    include:
      - main
  
variables: 
  - name: imageName
    value: 'flask-microservice'
  - name: imageTag
    value: '$(Build.BuildId)'
  - name: containerRegistry
    value: 'flaskappcontainerregistry.azurecr.io'
  - name: registryName
    value: 'flaskappcontainerregistry'
  - name: resourceGroup
    value: 'flask-microservice-rg'
  - name: containerAppName
    value: 'flask-app'
  - name: containerEnvironment
    value: 'flask-container-environment'

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Build
    displayName: 'Build and Push Stage'
    jobs:
      - job: Build
        displayName: 'Docker Build and Push'
        steps:
          - checkout: self
            displayName: 'Checkout Repository'
            fetchDepth: 1
          
          - task: Docker@2
            displayName: 'Build and Push Docker Image'
            inputs:
              command: 'buildAndPush'
              containerRegistry: 'jk-docker-connection'
              repository: '$(imageName)'
              dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
              tags: |
                $(imageTag)
                latest
            
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Deployment Artifacts'
            inputs:
              targetPath: '$(Build.SourcesDirectory)'
              artifact: 'flask-microservice-artifacts'
    
  - stage: Deploy
    displayName: 'Deploy to Azure Container Apps'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: 'Container App Deployment'
        steps:
          - task: AzureCLI@2
            displayName: 'Azure Container Registry Authentication'
            inputs:
              azureSubscription: 'jk-sp-azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Login to Azure Container Registry using service principal
                az acr login --name $(registryName)
                
                # Verify image exists and is pullable
                az acr repository show-tags \
                  --name $(registryName) \
                  --repository $(imageName) \
                  --query "contains(@, '$(imageTag)')" \
                  --output tsv
          
          - task: AzureCLI@2
            displayName: 'Deploy to Azure Container Apps'
            inputs:
              azureSubscription: 'jk-sp-azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Create ACR credentials for Container App
                ACR_USERNAME=$(az acr credential show --name $(registryName) --query username -o tsv)
                ACR_PASSWORD=$(az acr credential show --name $(registryName) --query passwords[0].value -o tsv)
                
                # Ensure container environment exists
                az containerapp env show \
                  --name $(containerEnvironment) \
                  --resource-group $(resourceGroup) \
                  || az containerapp env create \
                  --name $(containerEnvironment) \
                  --resource-group $(resourceGroup)
                
                # Deploy or update container app with explicit registry credentials
                az containerapp update \
                  --name $(containerAppName) \
                  --resource-group $(resourceGroup) \
                  --image $(containerRegistry)/$(imageName):$(imageTag) \
                  --registry-server $(containerRegistry) \
                  --registry-username $ACR_USERNAME \
                  --registry-password $ACR_PASSWORD
                
                # Verify and output deployment details
                az containerapp show \
                  --name $(containerAppName) \
                  --resource-group $(resourceGroup) \
                  --query "{name:name, status:properties.provisioningState, url:properties.configuration.ingress.fqdn}" \
                  --output jsonc
